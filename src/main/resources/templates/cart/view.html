<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MINARI | Cart</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- Navbar Scripts & Meta -->
    <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}" />
    <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}" />
    <meta name="csrf-token" th:content="${_csrf != null ? _csrf.token : ''}" />
    <script th:inline="javascript">
        window.APP_ROLE = /*[[${#authorization.expression('isAuthenticated()') ? 'user' : 'guest'}]]*/ 'guest';
        window.APP_URL = /*[[@{/}]]*/ '/';
        window.CSRF_TOKEN = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    </script>

    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/css/cart.css}">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
</head>

<body>

    <header id="navMount"></header>

    <a th:href="@{/products}" class="btn btn-primary">Continue Shopping</a>
    </div>

    <div th:unless="${cart == null or cart.items == null or cart.items.isEmpty()}">
        <!-- Guest notification -->
        <div th:if="${isGuest}" class="alert alert-info d-flex align-items-center mb-3">
            <i class="bi bi-info-circle me-2"></i>
            <div>
                You're shopping as a guest.
                <a th:href="@{/login}" class="alert-link">Log in</a>
                to save your cart and checkout faster.
            </div>
        </div>

        <!-- Select All -->
        <div class="d-flex align-items-center gap-2 mb-2">
            <input type="checkbox" id="selectAll" class="form-check-input" />
            <label for="selectAll" class="form-check-label fw-semibold">Select All</label>
        </div>
        <hr>

        <!-- Cart List -->
        <div id="cartList" class="vstack gap-4">
            <div class="cart-item d-flex align-items-center" th:each="item : ${cart.items}"
                th:data-id="${item.productId}" th:data-price="${item.price}" th:data-is-guest="${isGuest}">

                <!-- Checkbox -->
                <div class="me-3 me-md-4">
                    <div class="custom-check-wrapper">
                        <input type="checkbox" class="custom-check-input item-check" />
                        <label class="custom-check-label"></label>
                    </div>
                </div>

                <!-- Image -->
                <div class="me-3 me-md-4">
                    <img th:src="${item.imageUrl != null ? item.imageUrl : '/images/default-product.jpg'}"
                        class="item-thumb" th:alt="${item.productName}">
                </div>

                <!-- Details -->
                <div class="flex-grow-1">
                    <h5 class="mb-1 product-title" th:text="${item.productName}">Product Name</h5>
                    <div class="product-price"
                        th:text="'Rp ' + ${#numbers.formatDecimal(item.price, 0, 'POINT', 0, 'COMMA')} + ',00'">Rp
                        100.000,00</div>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <div class="qty-wrap">
                        <button class="qty-btn btnMinus" onclick="updateQuantity(this, -1)">âˆ’</button>
                        <input type="number" class="qty-input item-qty" min="1" th:value="${item.quantity}" readonly />
                        <button class="qty-btn btnPlus" onclick="updateQuantity(this, 1)">+</button>
                    </div>

                    <form th:action="@{/cart/remove}" method="POST" style="display:inline;">
                        <input type="hidden" name="productId"
                            th:value="${item.productId != null ? item.productId : item.product.id}" />
                        <button type="submit" class="btn btn-outline-danger btn-sm remove-item">
                            <i class="fas fa-trash"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="mt-4 d-flex justify-content-between align-items-center">
            <h5>Total: <span id="cartTotal">Rp 0</span></h5>
            <a th:href="@{/checkout}" class="btn btn-primary btn-lg">Checkout</a>
        </div>
    </div>
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/navbar.js}"></script>
    <script th:inline="javascript">
        // Simple script to handle totals and checkboxes (simplified from original cart.js reference)
        document.addEventListener('DOMContentLoaded', () => {
            const checks = document.querySelectorAll('.item-check');
            const selectAll = document.getElementById('selectAll');
            const totalSpan = document.getElementById('cartTotal');

            function calculateTotal() {
                let total = 0;
                document.querySelectorAll('.cart-item').forEach(row => {
                    const check = row.querySelector('.item-check');
                    if (check && check.checked) {
                        const price = parseFloat(row.getAttribute('data-price'));
                        const qty = parseInt(row.querySelector('.item-qty').value);
                        total += price * qty;
                    }
                });
                if (totalSpan) {
                    totalSpan.textContent = 'Rp ' + total.toLocaleString('id-ID');
                }
            }

            if (selectAll) {
                selectAll.addEventListener('change', (e) => {
                    checks.forEach(c => c.checked = e.target.checked);
                    calculateTotal();
                });
            }

            checks.forEach(c => {
                c.addEventListener('change', calculateTotal);
            });

            // Initial calc
            calculateTotal();
        });

        function updateQuantity(btn, change) {
            // Implement AJAX update if needed, for now just UI
            const input = btn.parentElement.querySelector('input');
            let val = parseInt(input.value) + change;
            if (val < 1) val = 1;
            input.value = val;
            // Trigger generic change event to update total
            const event = new Event('change');
            input.closest('.cart-item').querySelector('.item-check').dispatchEvent(event);
        }
    </script>
</body>

</html>