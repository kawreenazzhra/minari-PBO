<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MINARI | Cart</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- Navbar Scripts & Meta -->
    <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}" />
    <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}" />
    <meta name="csrf-token" th:content="${_csrf != null ? _csrf.token : ''}" />
    <script th:inline="javascript">
        window.APP_ROLE = /*[[${#authorization.expression('isAuthenticated()') ? 'user' : 'guest'}]]*/ 'guest';
        window.APP_URL = /*[[@{/}]]*/ '/';
        window.CSRF_TOKEN = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
    </script>

    <!-- CSS -->
    <link rel="stylesheet" th:href="@{/css/cart.css}">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
</head>

<body>

    <header id="navMount"></header>

    <div class="container mt-4 main-cart-container">
        <a th:href="@{/}" class="btn btn-primary mb-3">
            <i class="bi bi-arrow-left"></i> Continue Shopping
        </a>

        <div th:unless="${cart == null or cart.items == null or cart.items.isEmpty()}">
            <!-- Guest notification -->
            <div th:if="${isGuest}" class="alert alert-info d-flex align-items-center mb-3">
                <i class="bi bi-info-circle me-2"></i>
                <div>
                    You're shopping as a guest.
                    <a th:href="@{/login}" class="alert-link">Log in</a>
                    to save your cart and checkout faster.
                </div>
            </div>

            <!-- Select All -->
            <div class="d-flex align-items-center gap-2 mb-2">
                <div class="custom-check-wrapper">
                    <input type="checkbox" id="selectAll" class="custom-check-input" />
                    <label for="selectAll" class="custom-check-label"></label>
                </div>
                <label for="selectAll" class="form-check-label fw-semibold" style="cursor: pointer;">Select All</label>
            </div>
            <hr>

            <!-- Cart List -->
            <div id="cartList" class="vstack gap-4">
                <div class="cart-item d-flex align-items-center" th:each="item : ${cart.items}"
                    th:data-id="${item.productId}" th:data-price="${item.price}" th:data-is-guest="${isGuest}">

                    <!-- Checkbox -->
                    <div class="me-3 me-md-4">
                        <div class="custom-check-wrapper">
                            <input type="checkbox" class="custom-check-input item-check"
                                th:id="'check-' + ${item.productId}" />
                            <label class="custom-check-label" th:for="'check-' + ${item.productId}"></label>
                        </div>
                    </div>

                    <!-- Image -->
                    <div class="me-3 me-md-4">
                        <img th:src="${item.imageUrl != null ? item.imageUrl : '/images/default-product.jpg'}"
                            class="item-thumb" th:alt="${item.productName}">
                    </div>

                    <!-- Details -->
                    <div class="flex-grow-1">
                        <h5 class="mb-1 product-title" th:text="${item.productName}">Product Name</h5>
                        <div class="product-price"
                            th:text="'Rp ' + ${#numbers.formatDecimal(item.price, 0, 'POINT', 0, 'COMMA')} + ',00'">Rp
                            100.000,00</div>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="qty-wrap">
                            <button class="qty-btn btnMinus">âˆ’</button>
                            <input type="number" class="qty-input item-qty" min="1" th:value="${item.quantity}"
                                readonly />
                            <button class="qty-btn btnPlus">+</button>
                        </div>

                        <button class="btn btn-outline-danger btn-sm remove-item">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sticky Total Footer -->
            <div class="sticky-total mt-4 d-flex justify-content-between align-items-center px-4">
                <h5 class="mb-0 text-white">Total: <span id="totalPrice" class="fw-bold">Rp 0</span></h5>
                <button id="checkoutBtn" class="btn btn-lg" disabled>Checkout</button>
            </div>
        </div>

        <div th:if="${cart == null or cart.items == null or cart.items.isEmpty()}" class="text-center py-5">
            <i class="bi bi-cart-x display-1 text-muted"></i>
            <h3 class="mt-3">Your cart is empty</h3>
            <p class="text-muted">Looks like you haven't added anything to your cart yet.</p>
            <a th:href="@{/products}" class="btn btn-primary mt-3">Start Shopping</a>
        </div>
    </div>

    <!-- Login Modal Placeholder (if needed by cart.js) -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Please Log In</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p>You need to log in to proceed to checkout.</p>
                    <a th:href="@{/login}" class="btn btn-primary w-100">Log In</a>
                    <div class="mt-2">Don't have an account? <a th:href="@{/register}">Register</a></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/navbar.js}"></script>
    <script th:src="@{/js/cart.js}"></script>
</body>

</html>