<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Products - Minari E-Commerce</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="container py-4">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="h2 mb-2">
                        <span th:if="${searchQuery != null}">Search Results for "</span>
                        <span th:if="${selectedCategory != null}">Products in </span>
                        <span th:if="${searchQuery == null and selectedCategory == null}">All Products</span>
                        <span th:text="${searchQuery != null ? searchQuery : (selectedCategory != null ? selectedCategory.name : '')}"></span>
                        <span th:if="${searchQuery != null}">"</span>
                    </h1>
                    <p class="text-muted mb-0">
                        <span th:text="${products != null ? products.size() : 0}">0</span> products found
                    </p>
                </div>
            </div>

            <div class="row">
                <!-- Sidebar Filters -->
                <div class="col-lg-3 mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Filters</h5>

                            <!-- Categories -->
                            <div class="mb-4">
                                <h6 class="fw-bold mb-3">Categories</h6>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item px-0 py-2 border-0">
                                        <a href="/products" class="text-decoration-none"
                                           th:classappend="${selectedCategory == null ? 'fw-bold text-primary' : ''}">
                                            All Categories
                                        </a>
                                    </li>
                                    <li class="list-group-item px-0 py-2 border-0"
                                        th:each="category : ${categories}">
                                        <a th:href="@{/products(category=${category.id})}"
                                           class="text-decoration-none"
                                           th:classappend="${selectedCategory != null and selectedCategory.id == category.id ? 'fw-bold text-primary' : ''}"
                                           th:text="${category.name}">Category Name</a>
                                    </li>
                                </ul>
                            </div>

                            <!-- Price Range -->
                            <div class="mb-4">
                                <h6 class="fw-bold mb-3">Price Range</h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <input type="number" class="form-control form-control-sm" id="minPrice" placeholder="Min" min="0">
                                    </div>
                                    <div class="col-6">
                                        <input type="number" class="form-control form-control-sm" id="maxPrice" placeholder="Max" min="0">
                                    </div>
                                </div>
                                <button class="btn btn-outline-primary btn-sm w-100 mt-2" onclick="applyPriceFilter()">
                                    Apply Filter
                                </button>
                            </div>

                            <!-- Clear Filters -->
                            <div class="mb-0">
                                <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters()">
                                    <i class="fas fa-times me-1"></i>Clear All Filters
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-lg-9">
                    <!-- Sort and View Options -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center gap-3">
                            <select class="form-select form-select-sm" id="sortSelect" style="width: auto;">
                                <option value="name">Name (A-Z)</option>
                                <option value="price_asc">Price (Low to High)</option>
                                <option value="price_desc">Price (High to Low)</option>
                                <option value="rating">Highest Rated</option>
                                <option value="newest">Newest First</option>
                            </select>
                        </div>

                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="viewMode" id="gridView" autocomplete="off" checked>
                            <label class="btn btn-outline-secondary btn-sm" for="gridView">
                                <i class="fas fa-th"></i>
                            </label>
                            <input type="radio" class="btn-check" name="viewMode" id="listView" autocomplete="off">
                            <label class="btn btn-outline-secondary btn-sm" for="listView">
                                <i class="fas fa-list"></i>
                            </label>
                        </div>
                    </div>

                    <!-- Products Grid -->
                    <div class="row g-4" id="productsGrid">
                        <div class="col-xl-4 col-lg-6 col-md-6" th:each="product : ${products}">
                            <div class="card product-card h-100">
                                <div class="position-relative">
                                    <img th:src="${product.imageUrl != null ? product.imageUrl : 'https://via.placeholder.com/300x250?text=No+Image'}"
                                         class="card-img-top" th:alt="${product.name}" style="height: 250px; object-fit: cover;">
                                    <span th:if="${product.isFeatured}" class="badge bg-warning text-dark position-absolute top-0 start-0 m-2">
                                        <i class="fas fa-star me-1"></i>Featured
                                    </span>
                                </div>
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title" th:text="${product.name}">Product Name</h5>
                                    <p class="card-text text-muted small" th:text="${product.shortDescription != null ? product.shortDescription : 'No description available'}">Product description</p>

                                    <!-- Rating -->
                                    <div class="mb-2">
                                        <div class="rating">
                                            <i class="fas fa-star" th:each="i : ${#numbers.sequence(1, 5)}"
                                               th:classappend="${i <= product.averageRating} ? '' : 'far'"></i>
                                        </div>
                                        <small class="text-muted ms-2" th:text="'(' + ${product.reviewCount} + ' reviews)'">(0 reviews)</small>
                                    </div>

                                    <!-- Price -->
                                    <div class="mt-auto">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div>
                                                <span class="price fw-bold text-success" th:text="'Rp ' + ${product.price}">Rp 0</span>
                                                <span th:if="${product.discountPrice != null}" class="original-price ms-2"
                                                      th:text="'Rp ' + ${product.discountPrice}">Rp 0</span>
                                            </div>
                                            <!-- Stock Status -->
                                            <small th:if="${product.stockQuantity > 0}" class="text-success">
                                                <i class="fas fa-check-circle"></i> In Stock
                                            </small>
                                            <small th:if="${product.stockQuantity == 0}" class="text-danger">
                                                <i class="fas fa-times-circle"></i> Out of Stock
                                            </small>
                                        </div>
                                    </div>

                                    <div class="mt-3 d-flex gap-2">
                                        <a th:href="@{/products/{id}(id=${product.id})}" class="btn btn-primary flex-fill">View Details</a>
                                        <button th:if="${product.stockQuantity > 0}"
                                                class="btn btn-outline-primary"
                                                th:onclick="'addToCart(' + ${product.id} + ')'">
                                            <i class="fas fa-cart-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- No Products Found -->
                    <div th:if="${products == null or products.empty}" class="text-center py-5">
                        <i class="fas fa-search fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">No products found</h4>
                        <p class="text-muted mb-4">
                            <span th:if="${searchQuery != null}">Try adjusting your search terms or browse all products.</span>
                            <span th:if="${searchQuery == null}">No products available in this category.</span>
                        </p>
                        <a href="/products" class="btn btn-primary">Browse All Products</a>
                    </div>

                    <!-- Pagination -->
                    <nav th:if="${products != null and !products.empty and products.size() > 12}" aria-label="Product pagination" class="mt-5">
                        <ul class="pagination justify-content-center">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">Previous</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <div layout:fragment="scripts">
        <script>
            // Add to cart function
            function addToCart(productId) {
                fetch('/cart/add/' + productId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ quantity: 1 })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('Product added to cart!', 'success');
                        updateCartBadge();
                    } else {
                        showAlert('Failed to add product to cart', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('An error occurred', 'danger');
                });
            }

            // Update cart badge
            function updateCartBadge() {
                fetch('/cart/count')
                .then(response => response.json())
                .then(data => {
                    const badge = document.querySelector('.cart-badge');
                    if (badge) {
                        badge.textContent = data.count;
                        badge.style.display = data.count > 0 ? 'inline' : 'none';
                    }
                });
            }

            // Apply price filter
            function applyPriceFilter() {
                const minPrice = document.getElementById('minPrice').value;
                const maxPrice = document.getElementById('maxPrice').value;

                let url = '/products?';
                if (minPrice) url += 'minPrice=' + minPrice + '&';
                if (maxPrice) url += 'maxPrice=' + maxPrice + '&';

                window.location.href = url.slice(0, -1);
            }

            // Clear filters
            function clearFilters() {
                window.location.href = '/products';
            }

            // Sort products
            document.getElementById('sortSelect').addEventListener('change', function() {
                const sortBy = this.value;
                const url = new URL(window.location);

                // Remove existing sort parameter
                url.searchParams.delete('sort');

                // Add new sort parameter
                if (sortBy !== 'name') {
                    url.searchParams.set('sort', sortBy);
                }

                window.location.href = url.toString();
            });

            // View mode toggle
            document.querySelectorAll('input[name="viewMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const grid = document.getElementById('productsGrid');
                    if (this.id === 'listView') {
                        grid.className = 'row g-3'; // List view
                    } else {
                        grid.className = 'row g-4'; // Grid view
                    }
                });
            });

            // Show alert function
            function showAlert(message, type) {
                const alertHtml = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                document.querySelector('main').insertAdjacentHTML('afterbegin', alertHtml);

                // Auto dismiss after 3 seconds
                setTimeout(() => {
                    const alert = document.querySelector('.alert');
                    if (alert) {
                        alert.remove();
                    }
                }, 3000);
            }

            // Initialize on page load
            document.addEventListener('DOMContentLoaded', function() {
                updateCartBadge();
            });
        </script>
    </div>
</body>
</html>

