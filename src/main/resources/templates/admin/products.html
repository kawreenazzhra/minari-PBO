<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/layout}">
<head>
    <title>Product Management - MINARI Admin</title>
</head>
<body>
    <layout:fragment name="content">
        <!-- Page Header -->
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem;">
            <div>
                <h1 style="font-size: 1.875rem; font-weight: 700; color: #1f2937; margin: 0;">Products</h1>
                <p style="color: #6b7280; margin-top: 0.25rem; margin-bottom: 0;">Manage your product catalog</p>
            </div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Add Product
            </button>
        </div>

        <!-- Stats Cards -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div style="background-color: #ffffff; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid #e5e7eb;">
                <p style="color: #6b7280; font-size: 0.875rem; font-weight: 500; margin: 0;">Total Products</p>
                <p style="font-size: 1.875rem; font-weight: 700; color: #1f2937; margin-top: 0.5rem; margin-bottom: 0;" th:text="${totalProducts}">0</p>
            </div>
            <div style="background-color: #ffffff; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid #e5e7eb;">
                <p style="color: #6b7280; font-size: 0.875rem; font-weight: 500; margin: 0;">Active Products</p>
                <p style="font-size: 1.875rem; font-weight: 700; color: #16a34a; margin-top: 0.5rem; margin-bottom: 0;" th:text="${activeProducts}">0</p>
            </div>
            <div style="background-color: #ffffff; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid #e5e7eb;">
                <p style="color: #6b7280; font-size: 0.875rem; font-weight: 500; margin: 0;">Low Stock</p>
                <p style="font-size: 1.875rem; font-weight: 700; color: #ea580c; margin-top: 0.5rem; margin-bottom: 0;" th:text="${lowStockProducts}">0</p>
            </div>
            <div style="background-color: #ffffff; border-radius: 0.5rem; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid #e5e7eb;">
                <p style="color: #6b7280; font-size: 0.875rem; font-weight: 500; margin: 0;">Out of Stock</p>
                <p style="font-size: 1.875rem; font-weight: 700; color: #dc2626; margin-top: 0.5rem; margin-bottom: 0;" th:text="${outOfStockProducts}">0</p>
            </div>
        </div>

        <!-- Empty State -->
        <div style="text-align: center; padding: 3rem 1rem;" th:if="${products.isEmpty()}">
            <svg style="margin: 0 auto; height: 3rem; width: 3rem; color: #d1d5db;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
            </svg>
            <h3 style="margin-top: 1rem; font-size: 1.125rem; font-weight: 500; color: #1f2937;">No products yet</h3>
            <p style="margin-top: 0.5rem; color: #6b7280;">Create categories first, then add your products.</p>
            <button style="margin-top: 1.5rem;" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Create First Product
            </button>
        </div>

        <!-- Products Table -->
        <div style="background-color: #ffffff; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); border: 1px solid #e5e7eb;" th:if="${!products.isEmpty()}">
            <table class="table" style="width: 100%; border-collapse: collapse;">
                <thead style="background-color: #f9fafb;">
                    <tr>
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #6b7280; font-size: 0.875rem; border-bottom: 1px solid #e5e7eb; text-transform: uppercase; letter-spacing: 0.05em;">Name</th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #6b7280; font-size: 0.875rem; border-bottom: 1px solid #e5e7eb; text-transform: uppercase; letter-spacing: 0.05em;">Category</th>
                        <th style="padding: 1rem; text-align: left; font-weight: 600; color: #6b7280; font-size: 0.875rem; border-bottom: 1px solid #e5e7eb; text-transform: uppercase; letter-spacing: 0.05em;">Price</th>
                        <th style="padding: 1rem; text-align: center; font-weight: 600; color: #6b7280; font-size: 0.875rem; border-bottom: 1px solid #e5e7eb; text-transform: uppercase; letter-spacing: 0.05em;">Stock</th>
                        <th style="padding: 1rem; text-align: center; font-weight: 600; color: #6b7280; font-size: 0.875rem; border-bottom: 1px solid #e5e7eb; text-transform: uppercase; letter-spacing: 0.05em;">Status</th>
                        <th style="padding: 1rem; text-align: right; font-weight: 600; color: #6b7280; font-size: 0.875rem; border-bottom: 1px solid #e5e7eb; text-transform: uppercase; letter-spacing: 0.05em;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="product : ${products}" style="border-bottom: 1px solid #e5e7eb;">
                        <td style="padding: 1rem; font-weight: 500;" th:text="${product.name}">Product Name</td>
                        <td style="padding: 1rem; color: #6b7280;" th:text="${product.category?.name ?: 'Uncategorized'}">Category</td>
                        <td style="padding: 1rem; font-weight: 500;">
                            <span style="color: #16a34a; font-weight: 600;" th:text="'$' + ${#numbers.formatDecimal(product.discountPrice ?: product.price, 1, 2)}"></span>
                        </td>
                        <td style="padding: 1rem; text-align: center;">
                            <span th:if="${product.stockQuantity > 0}" style="color: #16a34a;" th:text="${product.stockQuantity}"></span>
                            <span th:if="${product.stockQuantity == 0}" style="color: #dc2626;">Out</span>
                        </td>
                        <td style="padding: 1rem; text-align: center;">
                            <span class="badge" th:classappend="${product.isActive ? 'badge-success' : 'badge-danger'}"
                                  th:text="${product.isActive ? 'Active' : 'Inactive'}" style="padding: 0.375rem 0.75rem; border-radius: 9999px; font-size: 0.8125rem; font-weight: 600;"></span>
                        </td>
                        <td style="padding: 1rem; text-align: right;">
                            <button style="color: #2563eb; background: none; border: none; cursor: pointer; margin: 0 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.875rem;" 
                                    th:onclick="'editProduct(' + ${product.id} + ')'">Edit</button>
                            <button style="color: #dc2626; background: none; border: none; cursor: pointer; margin: 0 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.875rem;" 
                                    th:onclick="'deleteProduct(' + ${product.id} + ')'">Delete</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </layout:fragment>

    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title">Add New Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addProductForm" enctype="multipart/form-data" method="POST" action="/admin/products/create">
                    <div class="modal-body">
                        <div class="mb-4">
                            <label for="productName" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Product Name <span style="color: #dc2626;">*</span></label>
                            <input type="text" class="form-control" id="productName" name="name" placeholder="e.g., T-Shirt Blue" required style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                        </div>

                        <div class="mb-4">
                            <label for="productCategory" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Category <span style="color: #dc2626;">*</span></label>
                            <select class="form-control" id="productCategory" name="categoryId" required style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                <option value="">Select Category</option>
                                <option th:each="category : ${categories}" th:value="${category.id}" th:text="${category.name}">Category</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="productDescription" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Description</label>
                            <textarea class="form-control" id="productDescription" name="description" rows="3" placeholder="Product description..." style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"></textarea>
                        </div>

                        <div class="mb-4">
                            <label for="productPrice" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Price <span style="color: #dc2626;">*</span></label>
                            <input type="number" class="form-control" id="productPrice" name="price" min="0" step="0.01" required style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                        </div>

                        <div class="mb-4">
                            <label for="productStock" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Stock Quantity <span style="color: #dc2626;">*</span></label>
                            <input type="number" class="form-control" id="productStock" name="stockQuantity" min="0" required style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                        </div>

                        <div class="mb-4">
                            <label for="productImage" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Product Image <span style="color: #dc2626;">*</span></label>
                            <input type="file" class="form-control" id="productImage" name="image" accept="image/*" required style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                            <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">Max 2MB, recommended size: 600x600px</p>
                        </div>
                    </div>
                    <div class="modal-footer border-0 pt-0">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="background-color: #6b7280; color: white; padding: 0.5rem 1rem;">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div class="modal fade" id="editProductModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title">Edit Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editProductForm" enctype="multipart/form-data" method="POST">
                    <div class="modal-body">
                        <input type="hidden" id="editProductId" name="id">
                        <div class="mb-4">
                            <label for="editProductName" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Product Name <span style="color: #dc2626;">*</span></label>
                            <input type="text" class="form-control" id="editProductName" name="name" required style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                        </div>

                        <div class="mb-4">
                            <label for="editProductCategory" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Category <span style="color: #dc2626;">*</span></label>
                            <select class="form-control" id="editProductCategory" name="categoryId" required style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                <option value="">Select Category</option>
                                <option th:each="category : ${categories}" th:value="${category.id}" th:text="${category.name}">Category</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="editProductDescription" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Description</label>
                            <textarea class="form-control" id="editProductDescription" name="description" rows="3" style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"></textarea>
                        </div>

                        <div class="mb-4">
                            <label for="editProductPrice" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Price <span style="color: #dc2626;">*</span></label>
                            <input type="number" class="form-control" id="editProductPrice" name="price" min="0" step="0.01" required style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                        </div>

                        <div class="mb-4">
                            <label for="editProductStock" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Stock Quantity <span style="color: #dc2626;">*</span></label>
                            <input type="number" class="form-control" id="editProductStock" name="stockQuantity" min="0" required style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                        </div>

                        <div class="mb-4">
                            <label for="editProductImage" style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">Product Image</label>
                            <input type="file" class="form-control" id="editProductImage" name="image" accept="image/*" style="width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                            <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">Leave empty to keep current image</p>
                        </div>

                        <div class="mb-4">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="editProductActive" name="isActive" style="width: 1rem; height: 1rem;">
                                <span style="font-size: 0.875rem; font-weight: 500; color: #374151;">Active</span>
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer border-0 pt-0">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="background-color: #6b7280; color: white; padding: 0.5rem 1rem;">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Product</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        function editProduct(productId) {
            const row = event.target.closest('tr');
            const nameCell = row.cells[0].textContent.trim();
            const categoryCell = row.cells[1].textContent.trim();
            const priceCell = row.cells[2].textContent.trim();
            const stockCell = row.cells[3].textContent.trim();
            const statusCell = row.cells[4].textContent.trim();

            document.getElementById('editProductId').value = productId;
            document.getElementById('editProductName').value = nameCell;
            document.getElementById('editProductPrice').value = priceCell.replace('$', '').trim();
            document.getElementById('editProductStock').value = stockCell === 'Out' ? 0 : stockCell;
            document.getElementById('editProductActive').checked = statusCell.includes('Active');

            document.getElementById('editProductForm').action = '/admin/products/' + productId + '/update';
            new bootstrap.Modal(document.getElementById('editProductModal')).show();
        }

        function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                fetch('/admin/products/' + productId + '/delete', { method: 'POST' })
                    .then(response => {
                        if (response.ok || response.status === 302) {
                            showAlert('Product deleted successfully', 'success');
                            setTimeout(() => location.reload(), 1000);
                        }
                    })
                    .catch(error => showAlert('An error occurred', 'danger'));
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.style.padding = '1rem';
            alertDiv.style.borderRadius = '0.375rem';
            alertDiv.style.marginBottom = '1rem';
            alertDiv.style.display = 'flex';
            alertDiv.style.gap = '0.75rem';
            alertDiv.style.alignItems = 'flex-start';
            alertDiv.style.minWidth = '300px';
            alertDiv.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';

            if (type === 'success') {
                alertDiv.style.backgroundColor = '#d1fae5';
                alertDiv.style.color = '#065f46';
                alertDiv.style.borderLeft = '4px solid #10b981';
            } else {
                alertDiv.style.backgroundColor = '#fee2e2';
                alertDiv.style.color = '#991b1b';
                alertDiv.style.borderLeft = '4px solid #ef4444';
            }

            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);

            setTimeout(() => alertDiv.remove(), 3000);
        }

        document.getElementById('addProductForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch('/admin/products/create', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok || response.status === 302) {
                    showAlert('Product created successfully', 'success');
                    setTimeout(() => location.reload(), 1000);
                }
            })
            .catch(error => showAlert('An error occurred', 'danger'));
        });

        document.getElementById('editProductForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            fetch(this.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok || response.status === 302) {
                    showAlert('Product updated successfully', 'success');
                    setTimeout(() => location.reload(), 1000);
                }
            })
            .catch(error => showAlert('An error occurred', 'danger'));
        });
    </script>
</body>
</html>

