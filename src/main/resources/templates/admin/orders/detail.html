<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layouts/admin}">

<head>
    <title>Order Details</title>
    <style>
        .print-only {
            display: none;
        }

        @media print {

            .sidebar,
            .navbar-custom,
            .back-btn,
            .btn,
            .btn-cancel,
            .alert,
            form,
            .no-print,
            .action-icons {
                display: none !important;
            }

            body,
            .main-content {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                color: black !important;
                font-size: 12px !important;
            }

            .order-detail-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 15px !important;
                margin-bottom: 20px !important;
            }

            .print-only {
                display: block !important;
                margin-bottom: 20px;
                border-bottom: 2px solid #000;
                padding-bottom: 5px;
            }

            .invoice-brand {
                font-size: 24px;
                font-weight: bold;
                text-transform: uppercase;
                letter-spacing: 2px;
            }

            .delivery-info-card {
                display: none !important;
            }

            .product-img {
                display: block !important;
                width: 40px !important;
                height: 40px !important;
            }

            .main-content {
                margin-left: 0 !important;
                margin-top: 0 !important;
            }

            /* Reset layout margins */
        }
    </style>
</head>

<body>
    <div layout:fragment="content">
        <!-- Print Header -->
        <div class="print-only">
            <div class="d-flex justify-content-between align-items-end">
                <div>
                    <div class="invoice-brand">MINARI</div>
                    <div class="invoice-subtitle">Official Invoice & Receipt</div>
                </div>
                <div class="text-end">
                    <!-- Note: #dates or #temporals utility for current date -->
                    <div>Date: <span th:text="${#temporals.format(#temporals.createNow(), 'dd MMM yyyy')}">Date</span>
                    </div>
                    <div>Order #: <span th:text="${order.orderNumber}">#123</span></div>
                </div>
            </div>
        </div>

        <div class="order-detail-header">
            <div class="no-print">
                <div>
                    <a th:href="@{/admin/orders}" class="back-btn" style="text-decoration:none; color:inherit;">
                        <i class="fas fa-arrow-left"></i> Back to Orders
                    </a>
                    <h2 class="page-title mt-3" th:text="'Order #' + ${order.orderNumber}">Order #123</h2>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span th:class="'badge-status badge-' + ${#strings.toLowerCase(order.paymentStatus)}"
                        th:text="${#strings.capitalize(#strings.toLowerCase(order.paymentStatus))}">Paid</span>
                    <span th:class="'badge-status badge-' + ${#strings.toLowerCase(order.status)}"
                        th:text="${#strings.capitalize(#strings.toLowerCase(order.status))}">Pending</span>
                    <span class="detail-value"
                        th:text="${#temporals.format(order.orderDate, 'dd.MM.yyyy HH:mm')}">01.01.2025</span>
                </div>
            </div>
        </div>

        <div class="stats-grid order-detail-grid"
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <!-- Reusing stats-grid or custom styles -->
            <div class="order-detail-card">
                <h5>Customer Information</h5>
                <div class="detail-row">
                    <span class="detail-label">Customer</span>
                    <span class="detail-value" th:text="${order.customerName}">Name</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Email</span>
                    <span class="detail-value" th:text="${order.customerEmail}">Email</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Phone</span>
                    <span class="detail-value"
                        th:text="${order.customerPhone != null ? order.customerPhone : '-'}">-</span>
                </div>
            </div>

            <div class="order-detail-card">
                <h5>Shipping Address</h5>
                <div class="detail-value">
                    <span
                        th:text="${order.shippingAddressStreet} + ', ' + ${order.shippingAddressCity}">Address</span><br>
                    <span th:text="${order.shippingAddressState} + ' ' + ${order.shippingAddressPostalCode}">City
                        Zip</span>
                </div>
            </div>
        </div>

        <div class="order-detail-card">
            <h5>Order Items</h5>
            <div th:each="item : ${order.items}" class="product-item"
                style="display: flex; justify-content: space-between; border-bottom: 1px solid #f0f0f0; padding: 15px 0;">
                <div class="product-info" style="display: flex; gap: 15px;">
                    <div class="product-img"
                        style="width: 60px; height: 60px; border-radius: 8px; overflow: hidden; background: #f9f9f9;">
                        <!-- Assuming item has productImageUrl or similar, otherwise placeholder -->
                        <!-- OrderItemDTO might need enrichment for image. Currently DTO usually has basic info.
                              If image is missing in DTO, use placeholder. -->
                        <img th:src="@{/images/logofix.png}" alt="Product"
                            style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <div>
                        <div class="product-name" style="font-weight: 500; color: #000;" th:text="${item.productName}">
                            Product Name</div>
                        <div class="text-muted small" th:text="'Qty: ' + ${item.quantity}">Qty: 1</div>
                    </div>
                </div>
                <div class="product-price" style="font-weight: 600; color: #000;"
                    th:text="'Rp ' + ${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 0, 'POINT')}">Rp 100.000</div>
            </div>
        </div>

        <div class="stats-grid order-detail-grid"
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
            <div class="order-detail-card delivery-info-card">
                <h5>Delivery Information</h5>
                <div class="detail-row">
                    <span class="detail-label">Tracking Number</span>
                    <span class="detail-value"
                        th:text="${order.trackingNumber != null ? order.trackingNumber : '-'}">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Shipping Cost</span>
                    <span class="detail-value"
                        th:text="'Rp ' + ${#numbers.formatDecimal(order.shippingCost, 0, 'COMMA', 0, 'POINT')}">Rp
                        0</span>
                </div>

                <div th:if="${#strings.equalsIgnoreCase(order.paymentStatus, 'paid')}"
                    class="mt-4 pt-3 border-top no-print">
                    <h6>Update Shipping Status</h6>
                    <form th:action="@{/admin/orders/{id}/status(id=${order.id})}" method="POST" class="mt-2">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                        <div class="mb-3">
                            <label class="form-label small">Status</label>
                            <select name="status" class="form-select form-select-sm">
                                <option value="PENDING" th:selected="${order.status == 'PENDING'}">Pending</option>
                                <option value="PROCESSING" th:selected="${order.status == 'PROCESSING'}">Processing
                                </option>
                                <option value="SHIPPED" th:selected="${order.status == 'SHIPPED'}">Shipped</option>
                                <option value="DELIVERED" th:selected="${order.status == 'DELIVERED'}">Delivered
                                </option>
                                <option value="CANCELLED" th:selected="${order.status == 'CANCELLED'}">Cancelled
                                </option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Tracking Number (Required for Shipped)</label>
                            <input type="text" name="trackingNumber" class="form-control form-control-sm"
                                th:value="${order.trackingNumber}" placeholder="Enter receipt number">
                        </div>
                        <button type="submit" class="btn btn-dark btn-sm w-100">Update Status</button>
                    </form>
                </div>
                <div th:unless="${#strings.equalsIgnoreCase(order.paymentStatus, 'paid')}"
                    class="alert alert-warning mt-3 no-print">
                    <i class="fas fa-exclamation-triangle"></i> Payment Status is <strong
                        th:text="${order.paymentStatus}">PENDING</strong>. Order processing is locked until payment is
                    confirmed.
                </div>
            </div>

            <div class="order-detail-card">
                <h5>Payment Summary</h5>
                <div class="detail-row">
                    <span class="detail-label">Subtotal</span>
                    <span class="detail-value"
                        th:text="'Rp ' + ${#numbers.formatDecimal(order.subtotalAmount, 0, 'COMMA', 0, 'POINT')}">Rp
                        0</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Delivery</span>
                    <span class="detail-value"
                        th:text="'Rp ' + ${#numbers.formatDecimal(order.shippingCost, 0, 'COMMA', 0, 'POINT')}">Rp
                        0</span>
                </div>
                <div class="detail-row"
                    style="border-top: 2px solid #f0f0f0; font-weight: 600; padding-top: 10px; margin-top: 10px;">
                    <span class="detail-label">Grand Total</span>
                    <span class="detail-value"
                        th:text="'Rp ' + ${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')}">Rp
                        0</span>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-3 mt-4 no-print">
            <button class="btn-cancel" onclick="window.print()">Print Invoice</button>
        </div>
    </div>
</body>

</html>