<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.thymeleaf.org"
      layout:decorate="~{layout}">
<head>
    <title>My Profile - Minari E-Commerce</title>
</head>
<body>
    <div layout:fragment="content">
        <div class="container py-4">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="h2 mb-2">My Profile</h1>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/">Home</a></li>
                            <li class="breadcrumb-item active">My Profile</li>
                        </ol>
                    </nav>
                </div>
            </div>

            <div class="row">
                <!-- Sidebar Navigation -->
                <div class="col-lg-3 mb-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <div class="avatar-circle mb-3">
                                    <i class="fas fa-user fa-3x text-primary"></i>
                                </div>
                                <h5 class="mb-1" th:text="${user.firstName + ' ' + user.lastName}">John Doe</h5>
                                <p class="text-muted small mb-0" th:text="${user.email}">john@example.com</p>
                            </div>

                            <nav class="nav flex-column">
                                <a class="nav-link active" href="#profile" data-bs-toggle="tab">
                                    <i class="fas fa-user me-2"></i>Profile Information
                                </a>
                                <a class="nav-link" href="#addresses" data-bs-toggle="tab">
                                    <i class="fas fa-map-marker-alt me-2"></i>Addresses
                                </a>
                                <a class="nav-link" href="#orders" data-bs-toggle="tab">
                                    <i class="fas fa-shopping-bag me-2"></i>Order History
                                </a>
                                <a class="nav-link" href="#security" data-bs-toggle="tab">
                                    <i class="fas fa-shield-alt me-2"></i>Security
                                </a>
                                <a class="nav-link" href="#preferences" data-bs-toggle="tab">
                                    <i class="fas fa-cog me-2"></i>Preferences
                                </a>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-lg-9">
                    <div class="tab-content">
                        <!-- Profile Information Tab -->
                        <div class="tab-pane fade show active" id="profile">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0">Profile Information</h5>
                                </div>
                                <div class="card-body">
                                    <form th:action="@{/profile/update}" method="post" th:object="${user}">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="firstName" class="form-label">First Name</label>
                                                <input type="text" class="form-control" id="firstName" th:field="*{firstName}" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="lastName" class="form-label">Last Name</label>
                                                <input type="text" class="form-control" id="lastName" th:field="*{lastName}" required>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="email" class="form-label">Email Address</label>
                                            <input type="email" class="form-control" id="email" th:field="*{email}" readonly>
                                            <div class="form-text">Email cannot be changed. Contact support if needed.</div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="phone" class="form-label">Phone Number</label>
                                            <input type="tel" class="form-control" id="phone" th:field="*{phone}">
                                        </div>

                                        <div class="mb-3">
                                            <label for="dateOfBirth" class="form-label">Date of Birth</label>
                                            <input type="date" class="form-control" id="dateOfBirth" th:field="*{dateOfBirth}">
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Gender</label>
                                            <div class="row">
                                                <div class="col-auto">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="gender" id="male" value="MALE" th:checked="${user.gender == 'MALE'}">
                                                        <label class="form-check-label" for="male">Male</label>
                                                    </div>
                                                </div>
                                                <div class="col-auto">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="gender" id="female" value="FEMALE" th:checked="${user.gender == 'FEMALE'}">
                                                        <label class="form-check-label" for="female">Female</label>
                                                    </div>
                                                </div>
                                                <div class="col-auto">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="radio" name="gender" id="other" value="OTHER" th:checked="${user.gender == 'OTHER'}">
                                                        <label class="form-check-label" for="other">Other</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="d-flex gap-2">
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save me-2"></i>Save Changes
                                            </button>
                                            <a href="/profile" class="btn btn-outline-secondary">Cancel</a>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Addresses Tab -->
                        <div class="tab-pane fade" id="addresses">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">My Addresses</h5>
                                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addAddressModal">
                                        <i class="fas fa-plus me-2"></i>Add New Address
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div th:if="${addresses == null or addresses.empty}" class="text-center py-4">
                                        <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                                        <h6 class="text-muted">No addresses saved</h6>
                                        <p class="text-muted small">Add your delivery addresses for faster checkout</p>
                                    </div>

                                    <div th:if="${addresses != null and !addresses.empty}" class="row">
                                        <div class="col-md-6 mb-3" th:each="address : ${addresses}">
                                            <div class="card h-100">
                                                <div class="card-body">
                                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                                        <h6 class="card-title mb-0" th:text="${address.label}">Home</h6>
                                                        <div class="dropdown">
                                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                                <i class="fas fa-ellipsis-v"></i>
                                                            </button>
                                                            <ul class="dropdown-menu">
                                                                <li><a class="dropdown-item" href="#" th:onclick="'editAddress(' + ${address.id} + ')'">
                                                                    <i class="fas fa-edit me-2"></i>Edit</a></li>
                                                                <li><a class="dropdown-item text-danger" href="#" th:onclick="'deleteAddress(' + ${address.id} + ')'">
                                                                    <i class="fas fa-trash me-2"></i>Delete</a></li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                    <p class="card-text small text-muted mb-2" th:text="${address.street + ', ' + address.city + ', ' + address.province + ' ' + address.postalCode}">Address details</p>
                                                    <p class="card-text small mb-0" th:text="${address.phone}">Phone number</p>
                                                    <span th:if="${address.isDefault}" class="badge bg-primary">Default</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Order History Tab -->
                        <div class="tab-pane fade" id="orders">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0">Order History</h5>
                                </div>
                                <div class="card-body">
                                    <div th:if="${orders == null or orders.empty}" class="text-center py-4">
                                        <i class="fas fa-shopping-bag fa-3x text-muted mb-3"></i>
                                        <h6 class="text-muted">No orders yet</h6>
                                        <p class="text-muted small">Your order history will appear here</p>
                                        <a href="/products" class="btn btn-primary">Start Shopping</a>
                                    </div>

                                    <div th:if="${orders != null and !orders.empty}">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Order #</th>
                                                        <th>Date</th>
                                                        <th>Status</th>
                                                        <th>Total</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr th:each="order : ${orders}">
                                                        <td>
                                                            <a th:href="@{/orders/{id}(id=${order.id})}" class="text-decoration-none fw-bold"
                                                               th:text="'#' + ${order.id}">Order ID</a>
                                                        </td>
                                                        <td th:text="${#temporals.format(order.createdAt, 'dd MMM yyyy')}">Date</td>
                                                        <td>
                                                            <span class="badge" th:classappend="${order.status == 'PENDING' ? 'bg-warning' :
                                                                                               order.status == 'CONFIRMED' ? 'bg-info' :
                                                                                               order.status == 'SHIPPED' ? 'bg-primary' :
                                                                                               order.status == 'DELIVERED' ? 'bg-success' :
                                                                                               'bg-secondary'}"
                                                                  th:text="${order.status}">Status</span>
                                                        </td>
                                                        <td th:text="'Rp ' + ${order.total}">Total</td>
                                                        <td>
                                                            <a th:href="@{/orders/{id}(id=${order.id})}" class="btn btn-sm btn-outline-primary">View</a>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Security Tab -->
                        <div class="tab-pane fade" id="security">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0">Security Settings</h5>
                                </div>
                                <div class="card-body">
                                    <!-- Change Password -->
                                    <div class="mb-4">
                                        <h6 class="mb-3">Change Password</h6>
                                        <form th:action="@{/profile/change-password}" method="post">
                                            <div class="mb-3">
                                                <label for="currentPassword" class="form-label">Current Password</label>
                                                <input type="password" class="form-control" id="currentPassword" name="currentPassword" required autocomplete="current-password">
                                            </div>
                                            <div class="mb-3">
                                                <label for="newPassword" class="form-label">New Password</label>
                                                <input type="password" class="form-control" id="newPassword" name="newPassword" minlength="8" required autocomplete="new-password">
                                            </div>
                                            <div class="mb-3">
                                                <label for="confirmNewPassword" class="form-label">Confirm New Password</label>
                                                <input type="password" class="form-control" id="confirmNewPassword" name="confirmNewPassword" required autocomplete="new-password">
                                            </div>
                                            <button type="submit" class="btn btn-primary">Update Password</button>
                                        </form>
                                    </div>

                                    <!-- Two-Factor Authentication -->
                                    <div class="mb-4">
                                        <h6 class="mb-3">Two-Factor Authentication</h6>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <p class="mb-1">Add an extra layer of security to your account</p>
                                                <small class="text-muted">Receive codes via SMS or authenticator app</small>
                                            </div>
                                            <button class="btn btn-outline-primary" id="enable2FA">Enable 2FA</button>
                                        </div>
                                    </div>

                                    <!-- Login Sessions -->
                                    <div class="mb-0">
                                        <h6 class="mb-3">Active Sessions</h6>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Device</th>
                                                        <th>Location</th>
                                                        <th>Last Active</th>
                                                        <th>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>Chrome on Windows</td>
                                                        <td>Jakarta, Indonesia</td>
                                                        <td>Now</td>
                                                        <td><span class="text-muted">Current</span></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Preferences Tab -->
                        <div class="tab-pane fade" id="preferences">
                            <div class="card border-0 shadow-sm">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0">Preferences</h5>
                                </div>
                                <div class="card-body">
                                    <form th:action="@{/profile/preferences}" method="post">
                                        <!-- Newsletter -->
                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="newsletter" name="newsletter" checked>
                                                <label class="form-check-label" for="newsletter">
                                                    Subscribe to newsletter
                                                </label>
                                            </div>
                                            <small class="text-muted">Receive updates about new products and promotions</small>
                                        </div>

                                        <!-- Order Updates -->
                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="orderUpdates" name="orderUpdates" checked>
                                                <label class="form-check-label" for="orderUpdates">
                                                    Order status updates
                                                </label>
                                            </div>
                                            <small class="text-muted">Get notified when your order status changes</small>
                                        </div>

                                        <!-- SMS Notifications -->
                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="smsNotifications" name="smsNotifications">
                                                <label class="form-check-label" for="smsNotifications">
                                                    SMS notifications
                                                </label>
                                            </div>
                                            <small class="text-muted">Receive important updates via SMS</small>
                                        </div>

                                        <!-- Language -->
                                        <div class="mb-3">
                                            <label class="form-label">Language</label>
                                            <select class="form-select" name="language">
                                                <option value="en">English</option>
                                                <option value="id">Bahasa Indonesia</option>
                                            </select>
                                        </div>

                                        <!-- Currency -->
                                        <div class="mb-3">
                                            <label class="form-label">Currency</label>
                                            <select class="form-select" name="currency">
                                                <option value="IDR">Indonesian Rupiah (Rp)</option>
                                                <option value="USD">US Dollar ($)</option>
                                            </select>
                                        </div>

                                        <button type="submit" class="btn btn-primary">Save Preferences</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Address Modal -->
    <div class="modal fade" id="addAddressModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Address</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/profile/addresses}" method="post">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="label" class="form-label">Address Label</label>
                                <input type="text" class="form-control" id="label" name="label" placeholder="e.g., Home, Office" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="phone" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="phone" name="phone" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="street" class="form-label">Street Address</label>
                            <textarea class="form-control" id="street" name="street" rows="2" required></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="city" class="form-label">City</label>
                                <input type="text" class="form-control" id="city" name="city" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="province" class="form-label">Province</label>
                                <input type="text" class="form-control" id="province" name="province" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="postalCode" class="form-label">Postal Code</label>
                                <input type="text" class="form-control" id="postalCode" name="postalCode" required>
                            </div>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="isDefault" name="isDefault">
                            <label class="form-check-label" for="isDefault">
                                Set as default address
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Address</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div layout:fragment="scripts">
        <script>
            // Initialize tabs
            document.addEventListener('DOMContentLoaded', function() {
                const triggerTabList = [].slice.call(document.querySelectorAll('#profileTabs a'));
                triggerTabList.forEach(function(triggerEl) {
                    const tabTrigger = new bootstrap.Tab(triggerEl);
                    triggerEl.addEventListener('click', function(event) {
                        event.preventDefault();
                        tabTrigger.show();
                    });
                });

                // Handle URL hash for direct tab access
                const hash = window.location.hash;
                if (hash) {
                    const tab = document.querySelector(`a[href="${hash}"]`);
                    if (tab) {
                        const tabInstance = new bootstrap.Tab(tab);
                        tabInstance.show();
                    }
                }
            });

            // Address management functions
            function editAddress(addressId) {
                // Implement edit address functionality
                console.log('Edit address:', addressId);
            }

            function deleteAddress(addressId) {
                if (confirm('Are you sure you want to delete this address?')) {
                    fetch('/profile/addresses/' + addressId, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Failed to delete address');
                        }
                    });
                }
            }

            // Password confirmation validation
            document.addEventListener('DOMContentLoaded', function() {
                const newPassword = document.getElementById('newPassword');
                const confirmPassword = document.getElementById('confirmNewPassword');

                if (newPassword && confirmPassword) {
                    function validatePasswords() {
                        if (newPassword.value !== confirmPassword.value) {
                            confirmPassword.setCustomValidity('Passwords do not match');
                        } else {
                            confirmPassword.setCustomValidity('');
                        }
                    }

                    newPassword.addEventListener('input', validatePasswords);
                    confirmPassword.addEventListener('input', validatePasswords);
                }
            });
        </script>
    </div>

    <style>
        .avatar-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        .nav-link {
            color: #6c757d;
            border-radius: 0.375rem;
            margin-bottom: 0.25rem;
        }

        .nav-link:hover {
            background-color: #f8f9fa;
            color: #495057;
        }

        .nav-link.active {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .card {
            transition: box-shadow 0.15s ease-in-out;
        }

        .card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
        }
    </style>
</body>
</html>

